#!/bin/bash -e
# shellcheck disable=SC2086,SC1118

usage() {
  cat << EOF
Creates infrastructure resources in your aws cloud that has been utilized by hub components

Usage: $(basename "$0")

Parameters:
    --aws-region          AWS Region
    --aws-profile         AWS Profile
    -s  --silent          Suppress console outputs in favor of result codes
    --skip-guide          Suppress "What's next messages"
    -v  --verbose         For debug purpose
EOF
}

SILENT=${SILENT:-false}
GUIDE=${GUIDE:-true}

test -f ".env" && source .env

while [ "$1" != "" ]; do
  case $1 in
    --aws-region )      shift
                        export AWS_REGION="$1"
                        ;;
    --aws-profile )     shift
                        export AWS_PROFILE="$1"
                        ;;
    -S | --silent )     SILENT=true
                        ;;
    --skip-guide )      GUIDE=false
                        ;;
    -V | --verbose )    set -x
                        ;;
    -h | --help )       usage
                        exit
                        ;;
    * )                 usage
                        exit 1
  esac
  shift
done

if test ! -f .env; then
  SILENT || echo "Error: configuration file '.env' does not exist"
  GUIDE && cat << EOF

***

# What's next?

Please run:
  
$ hub configure --current-kubeconfig

EOF
  exit 1
fi

# TODO: replace this with smth better before script will be moved to extension
DOMAIN_NAME="$PLATFORM_NAME.$BASE_DOMAIN"
echo "Deploying AWS prerequisites for $DOMAIN_NAME stack"

pwd=$(dirname "$0")

set +e
echo -n "* Route53 hosted zone for $DOMAIN_NAME: "
# shellcheck disable=SC2046,SC2068
NS=$($pwd/aws/route53-zone/deploy --domain-name "$DOMAIN_NAME" --json)
if test "$?" = "0"; then 
  echo "Deployed"
else
  echo "Failed"
  exit 3
fi

echo -n "* S3 bucket $STATE_BUCKET for deployment state: "
$pwd/aws/s3-bucket/deploy \
  --bucket-name "$STATE_BUCKET" \
  --aws-region "$AWS_REGION" \
  --acl "private"
  
if test "$?" = "0"; then 
  echo "Deployed"
else
  echo "Failed"
  exit 4
fi
set -e

echo -n "* Sending $DOMAIN_NAME DNS delegation set: "
HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -X PUT \
      "https://api.agilestacks.io/dns/$DOMAIN_NAME" \
      -H 'Content-Type: application/json;charset=UTF-8' \
      -d "{\"key\": \"$DOMAIN_KEY\",\"nameservers\": $NS}")

if test "$(echo $HTTP_CODE | cut -c1-1)" != "2"; then
  echo "Failed"
  $SILENT || echo "Something went wrong. Please try again later!"
  exit 2
else 
echo "Done"
fi

$SILENT || cat << EOF

*** 

All prerequisites has been deployed. Ready to deploy $DOMAIN_NAME stack.

## What's next?

Please feel free to run:

$ hub ext stack deploy

EOF
