#!/bin/bash -e
# shellcheck disable=SC2086,SC1118

usage() {
  cat << EOF
Creates infrastructure resources in your aws cloud that has been utilized by hub components

Usage: $(basename "$0")

Parameters:
    --aws-region          AWS Region
    --aws-profile         AWS Profile
    --rm-state-bucket     Delete state bucket as well
    -s  --silent          Suppress console outputs in favor of result codes
    -v  --verbose         For debug purpose
EOF
}

SILENT=false
RM_BUCKET=false

if [[ ! -f .env ]]; then
  cat << EOF

Error: cannot find .env file. Please run:
  
$ hub stack configure --kubecontext -

EOF
  exit 1
fi

source .env

test -n "$@" && while [ "$1" != "" ]; do
  case $1 in
    --aws-region )      shift
                        export AWS_REGION="$1"
                        ;;
    --aws-profile )     shift
                        export AWS_PROFILE="$1"
                        ;;
    --rm-state-bucket ) RM_BUCKET=true
                        ;;
    -S | --silent )     SILENT=true
                        ;;
    -V | --verbose )    set -x
                        ;;
    -h | --help )       usage
                        exit
                        ;;
    * )                 usage
                        exit 1
  esac
  shift
done

# TODO: replace this with smth better before script will be moved to extension
DOMAIN_NAME="$PLATFORM_NAME.$BASE_DOMAIN"
SUCCESS=true
pwd=$(dirname "$0")

set +e
echo "Deleting Route53 hosted zone for $DOMAIN_NAME..."
$pwd/aws/route53-zone/undeploy --domain-name "$DOMAIN_NAME"
if test "$?" != "0"; then 
  echo "Fail"
  SUCCESS=false
fi

if $RM_BUCKET; then
  echo "Deleting S3 bucket for $BUCKET_AME: not yet implemented!"
  SUCCESS=false
else 
  echo "Deleting S3 bucket for $BUCKET_AME: skip due to user setting"
fi

if ! $SUCCESS; then
  echo "Failed to remove one or multiple resources"
fi
