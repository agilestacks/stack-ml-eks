#!/bin/bash -e

usage() {
cat << EOF

Deploys this stack

Usage: 
$ $(basename "$0")

Deploys all components

$ $(basename "$0") -c component1,component2
Deploys deploys two components 

Parameters:
    -p --no-precheck       List of components to deploy
    -c --components         List of components to deploy
    -o --offset             Deploy starting with the given component

EOF
}

GUIDE=${GUIDE:-true}
SILENT=${SILENT:-false}
CLOUD_CHECK=true

while [ "$1" != "" ]; do
    case $1 in
        -p | --no-precheck ) 
                            CLOUD_CHECK=false
                            ;;
        -c | --component )  shift
                            HUB_DEPLOY_OPTS="$HUB_DEPLOY_OPTS -c $1"
                            ;;
        -o | --offset )     shift
                            HUB_DEPLOY_OPTS="$HUB_DEPLOY_OPTS -o $1"
                            ;;
        -S | --silent )     SILENT=true
                            exit
                            ;;
        -v | --verbose )    set -e
                            exit
                            ;;
        -h | --help )       usage
                            exit
                            ;;
        * )                 usage
                            exit 1
    esac
    shift
done

if test ! -f .env; then
cat << EOF
Configuration has not been found. To resolve please run:

$ hub configure --current-kube-context

EOF
  exit 1
fi
# shellcheck disable=SC1091
source .env

DOMAIN_NAME="$PLATFORM_NAME.$BASE_DOMAIN"

cat << EOF
Starting deployment $DOMAIN_NAME stack
* Using kubeconfig from $KUBECONFIG

EOF

if $CLOUD_CHECK; then
  set +e
  hub ext aws status --skip-guide
  hub_aws_rv="$?"
  set -e
fi

if test "$hub_aws_rv" = "2"; then
  cat << EOF
Error: Cannot find .env configuration. Please run:

$ hub ext configure --current-kube-config

EOF
  exit "$hub_aws_rv"

elif test "$hub_aws_rv" = "3"; then
  hub ext aws init --skip-guide
fi

HUB_ELABORATE_FILE=".hub/$DOMAIN_NAME.elaborate"
HUB_STATE_FILE=".hub/$DOMAIN_NAME.state"

if test -f "$HUB_STATE_FILE"; then
  HUB_ELABORATE_OPTS="$HUB_ELABORATE_OPTS -s $HUB_STATE_FILE"
fi

HUB_DEPLOY_OPTS="--clouds=aws $HUB_DEPLOY_OPTS"

# shellcheck disable=SC2086
hub elaborate hub.yaml params.yaml -o "$HUB_ELABORATE_FILE" $HUB_ELABORATE_OPTS

# shellcheck disable=SC2086
hub deploy "$HUB_ELABORATE_FILE" -s "$HUB_STATE_FILE" $HUB_DEPLOY_OPTS
