#!/bin/bash -e

usage() {
cat << EOF

Runs reconciliation for all parameters of this stack components
and this stack prerequisites

Usage: 
$ $(basename "$0")

Parameters:
    - --help    Show this message

EOF
}

while [ "$1" != "" ]; do
    case $1 in
        -h | --help )       usage
                            exit
                            ;;
        * )                 usage
                            exit 1
    esac
    shift
done

if [[ ! -f .env ]]; then
cat << EOF
Configuration has not been found. To resolve please run:

$ hub configure --kubecontext -

EOF
  exit 1
fi
# shellcheck disable=SC1091
source .env

DOMAIN_NAME="$PLATFORM_NAME.$BASE_DOMAIN"

cat << EOF
Reconciling deployment plan for $DOMAIN_NAME
EOF


HUB_ELABORATE_FILE=".hub/$DOMAIN_NAME.elaborate"
HUB_STATE_FILE=".hub/$DOMAIN_NAME.state"

if test -f "$HUB_STATE_FILE"; then
  HUB_ELABORATE_OPTS="$HUB_ELABORATE_OPTS -s $HUB_STATE_FILE"
fi

HUB_DEPLOY_OPTS="--clouds=aws $HUB_DEPLOY_OPTS"

# shellcheck disable=SC2086
hub elaborate hub.yaml params.yaml -o "$HUB_ELABORATE_FILE" $HUB_ELABORATE_OPTS

cat << EOF

***

Success. Deployment plan has been recalculated and stored in $HUB_ELABORATE_FILE

What's next. To apply plan run:

$ hub ext stack deploy

EOF
